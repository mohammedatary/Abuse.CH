import os
import requests
from bs4 import BeautifulSoup
from datetime import datetime, timedelta

url= "https://bazaar.abuse.ch/downloads/misp/"
def fetch_and_find_hash():
    #Fetch the hash for today's date from the MISP downloads page.
    today = datetime.now().strftime('%Y-%m-%d')
    response = requests.get(url)
    
    if response.status_code == 200:
        soup = BeautifulSoup(response.text, 'html.parser')
        rows = soup.find_all('tr')
        
        for row in rows:
            columns = row.find_all('td')
            if len(columns) >= 3:
                date_column = columns[2].text.strip()
                if date_column:
                    date_text = date_column.split()[0]
                    
                    if date_text == today:
                        hash_link = columns[1].find('a')
                        if hash_link:
                            hash_id = hash_link['href'].split('.')[0]
                            return hash_id
    
    print("No hash found for today's date.")
    return None

def download_json(hash_id):
    #Download and save the JSON file for the given hash ID.
    file_url = f"{url}{hash_id}.json"
    response = requests.get(file_url)
    
    if response.status_code == 200:
        today_str = datetime.now().strftime("%Y-%m-%d")
        filename = f'malwarebazaar{today_str}.json'
        
        with open(filename, 'wb') as file:
            file.write(response.content)
    
        print(f"File saved as {filename}")
    else:
        print(f"Failed to download the file. Status code: {response.status_code}")

def main():
    hash_id = fetch_and_find_hash()
    if hash_id: # If we found a file uploaded for today's results
        download_json(hash_id)

if __name__ == "__main__":
    main()
